<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digital Visiting Card Forms & Policy Upload</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f4f8; margin:0; padding:0; }
  .popup-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:999; }
  .form-popup { background:#fff; padding:16px; border-radius:8px; max-width:420px; width:90%; box-shadow:0 4px 12px rgba(0,0,0,0.2); position:relative; }
  .close-btn { position:absolute; top:6px; right:10px; cursor:pointer; font-weight:bold; font-size:18px; }
  button { cursor:pointer; }
</style>
</head>
<body>

<!-- Policy Upload Popup -->
<div id="policyPopup" class="form-popup" style="display:none;">
  <span class="close-btn" onclick="closeAllPopups()">×</span>
  <h3 id="policyTitle"></h3>
  <input type="text" id="policyCode" placeholder="6 अंकों का कोड" maxlength="6" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
  <div id="policyRows">
    <div class="policy-row" style="margin-bottom:6px;">
      <button class="upload-btn">Upload PDF</button>
      <button class="view-btn" disabled>View PDF</button>
    </div>
  </div>
  <button class="add-row" style="margin-top:8px;">Add Row</button>
  <div id="policyStatus" style="margin-top:8px;color:#007bff;"></div>
</div>

<!-- MF Form Popup -->
<div id="mfPopup" class="form-popup" style="display:none;">
  <span class="close-btn" onclick="closeAllPopups()">×</span>
  <h3>Mutual Fund Form</h3>
  <form id="mfForm">
    <input type="text" name="name" placeholder="नाम" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <input type="email" name="email" placeholder="ईमेल" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <input type="text" name="mobile" placeholder="मोबाइल" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <button type="submit" style="background:#007bff;color:#fff;padding:10px 14px;border:none;border-radius:8px;">सबमिट</button>
  </form>
</div>

<script>
/* ======= CONFIG ======= */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwdhotGmP0kjnPdDpYFzU5_f3dC8hxkf6m1kYHrloU3wjJ0XIPy64rTpaGuvv4SsBJO8w/exec'; // <-- Replace with your Apps Script /exec URL

/* ======= Popup helpers ======= */
function showPopup(el){
  const overlay = document.createElement('div');
  overlay.className = 'popup-overlay';
  overlay.appendChild(el);
  document.body.appendChild(overlay);
  overlay.addEventListener('click', function(evt){
    if(evt.target === overlay) closeAllPopups();
  });
}
function closeAllPopups(){
  document.querySelectorAll('.popup-overlay').forEach(o=>o.remove());
  document.querySelectorAll('.form-popup').forEach(p=>p.style.display='none');
}
document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeAllPopups(); });

function showPolicyStatus(msg){ const s=document.getElementById('policyStatus'); if(s)s.innerText=msg; }
function clearPolicyStatus(){ const s=document.getElementById('policyStatus'); if(s)s.innerText=''; }

/* ======= Open dynamic form ======= */
function openForm(service){
  const box = document.createElement('div');
  box.className='form-popup';
  box.style.maxWidth='420px';
  box.innerHTML=`
    <span class="close-btn" onclick="closeAllPopups()">×</span>
    <h3>${service} के लिए विवरण भरें</h3>
    <form class="tempForm" style="margin-top:8px;">
      <input type="hidden" name="formType" value="${service}">
      <input type="text" name="name" placeholder="आपका नाम" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <input type="email" name="email" placeholder="ईमेल" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <input type="text" name="mobile" placeholder="मोबाइल नम्बर" required style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <select name="time" required style="width:100%;margin-bottom:12px;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <option value="">कॉल करने का सही समय</option>
        <option>सुबह</option><option>दोपहर</option><option>शाम</option>
      </select>
      <button type="submit" style="background:#007bff;color:#fff;padding:10px 14px;border:none;border-radius:8px;">सबमिट</button>
    </form>
  `;
  showPopup(box);
  const form = box.querySelector('.tempForm');
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(this);
    fd.append('formType', service);
    fetch(GAS_URL, { method:'POST', body: fd })
      .then(()=>{ alert('आपका विवरण भेज दिया गया है!'); closeAllPopups(); })
      .catch(err=>{ console.error(err); alert('Error: '+err); });
  });
}

/* ======= PDF Upload & View ======= */
document.getElementById('policyRows').addEventListener('click', async function(e){
  const row = e.target.closest('.policy-row');
  if(e.target.classList.contains('add-row')){
    const first = document.querySelector('.policy-row');
    if(!first) return;
    const newRow = first.cloneNode(true);
    newRow.querySelector('.view-btn').disabled=true;
    newRow.dataset.pdfurl='';
    document.getElementById('policyRows').appendChild(newRow);
    return;
  }

  if(e.target.classList.contains('upload-btn')){
    const codeInput=document.getElementById('policyCode');
    const codeVal = codeInput.value.trim();
    if(!/^\d{6}$/.test(codeVal)){ alert('कृपया 6 अंकों का वैध कोड डालें।'); return; }
    const fileInput = document.createElement('input');
    fileInput.type='file'; fileInput.accept='application/pdf';
    fileInput.onchange = async ()=>{
      const file = fileInput.files[0]; if(!file) return;
      if(file.size>5*1024*1024){ alert('5 MB से छोटी फ़ाइल अपलोड करें।'); return; }
      showPolicyStatus('PDF अपलोड हो रहा है...');
      try{
        const arrayBuffer = await file.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
        const popup=document.getElementById('policyPopup');
        const policyType = popup.dataset.policyType || document.getElementById('policyTitle').innerText || '';
        const payload = { action:'uploadPdf', filename:file.name, base64:base64, code:codeVal, policyType:policyType };
        const resp = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const jd = await resp.json(); clearPolicyStatus();
        if(jd && jd.result==='success' && jd.fileUrl){
          const viewBtn=row.querySelector('.view-btn');
          if(viewBtn){ viewBtn.disabled=false; row.dataset.pdfurl=jd.fileUrl; }
          alert('PDF भेज दिया गया है');
        }else{ alert('Upload failed'); console.error(jd); }
      }catch(err){ clearPolicyStatus(); console.error(err); alert('Upload failed: '+err); }
    };
    fileInput.click(); return;
  }

  if(e.target.classList.contains('view-btn')){
    const codeInput=document.getElementById('policyCode');
    const codeVal = codeInput.value.trim();
    if(!/^\d{6}$/.test(codeVal)){ alert('कृपया 6 अंकों का वैध कोड डालें।'); return; }
    const popup=document.getElementById('policyPopup');
    const policyType = popup.dataset.policyType || document.getElementById('policyTitle').innerText || '';
    try{
      showPolicyStatus('Fetching policy...');
      const resp = await fetch(GAS_URL+'?action=getPdf&code='+encodeURIComponent(codeVal)+'&policyType='+encodeURIComponent(policyType));
      const jd = await resp.json(); clearPolicyStatus();
      if(jd && jd.fileUrl){ window.open(jd.fileUrl,'_blank'); }
      else{ alert('PDF नहीं मिली'); }
    }catch(err){ clearPolicyStatus(); console.error(err); alert('Error: '+err); }
  }
});

/* ======= MF Form submit ======= */
document.getElementById('mfForm').addEventListener('submit', function(e){
  e.preventDefault();
  const fd = new FormData(this);
  fetch(GAS_URL, { method:'POST', body: fd })
    .then(()=>{ alert('MF details sent'); closeAllPopups(); })
    .catch(err=>{ console.error(err); alert('Error: '+err); });
});
</script>
</body>
</html>
